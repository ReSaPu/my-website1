<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="blog.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Blog Post</title>
    <style>
        #loading-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            text-align: center;
            padding-top: 20%;
            font-size: 1.5em;
        }
        #progress-bar {
            width: 0;
            height: 30px;
            background-color: #4caf50;
            text-align: center;
            color: #fff;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCUm02w4bfMZXF9gYp8N__Zz0nCI1Wlfk",
            authDomain: "post-storage-18fd3.firebaseapp.com",
            projectId: "post-storage-18fd3",
            storageBucket: "post-storage-18fd3.appspot.com",
            messagingSenderId: "350528800013",
            appId: "1:350528800013:web:a04ee9dd4381407d825c44",
            measurementId: "G-GP4DH4E3S0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        async function checkTokenExpiration() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('uid');

            if (!token) {
                alert("No token found in URL.");
                window.location.href = "error.html";  // Redirect to an error page
                return;
            }

            try {
                // Fetch the token document from Firestore
                const tokenDoc = await getDoc(doc(db, "links", token));

                if (!tokenDoc.exists()) {
                    alert("Invalid token.");
                    window.location.href = "error.html";  // Redirect to an error page
                    return;
                }

                // Check if the token has expired
                const tokenData = tokenDoc.data();
                const expiresAt = new Date(tokenData.expiresAt);
                const currentTime = new Date();

                if (currentTime > expiresAt) {
                    alert("This link has expired.");
                    window.location.href = "error.html";  // Redirect to an error page
                } else {
                    // Token is valid; proceed with the rest of the page functionality
                    console.log("Token is valid.");
                }
            } catch (error) {
                console.error("Error checking token expiration:", error);
                alert("There was an error validating the token. Please try again.");
            }
        }

        async function createBlogPost() {
            console.log('Create Blog Post button clicked');
            
            const blogTitle = document.getElementById('blog-title').value;
            const blogText = document.getElementById('blog').value;
            const blogImage = document.getElementById('photo').files[0];
            const vimeoEmbedCode = document.getElementById('vimeo-embed').value;
            const address = document.getElementById('address').value;

            // Show loading progress
            const loadingContainer = document.getElementById('loading-container');
            const progressBar = document.getElementById('progress-bar');
            loadingContainer.style.display = 'block';

            // Upload the image and get the URL
            let imageUrl = '';
            if (blogImage) {
                console.log('Uploading image...');
                progressBar.style.width = '50%';  // Update progress bar to 50%
                imageUrl = await uploadToImgbb(blogImage);
                console.log('Image uploaded:', imageUrl);
            }

            // Generate a unique ID for the post
            const postId = Date.now().toString();  // Simple example; consider using UUID or another method

            // Store the blog post data in Firestore
            await setDoc(doc(db, 'posts', postId), {
                blogTitle,
                blogText,
                blogImage: imageUrl,
                vimeoEmbedCode,
                address
            });

            // Update progress bar to 100%
            progressBar.style.width = '100%';
            setTimeout(() => {
                loadingContainer.style.display = 'none';
                console.log('Redirecting to post.html?id=' + postId);
                window.location.href = 'post.html?id=' + postId;
            }, 500);  // Delay for a smooth transition
        }

        async function uploadToImgbb(imageFile) {
            const apiKey = '51719444556e62bb0a59ae15a1976b11';  // Replace with your Imgbb API key
            const formData = new FormData();
            formData.append('image', imageFile);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                return result.data.url;  // Return the URL of the uploaded image
            } else {
                throw new Error('Failed to upload image');
            }
        }

        // Make the function available globally
        window.createBlogPost = createBlogPost;
    </script>
</head>
<body>
    <h1>Create Blog Post</h1>
    <section class="bloginput">
        <label for="blog-title">Blog Title:</label>
        <input type="text" id="blog-title" name="title" placeholder="Enter your blog title"><br><br>

        <label for="vimeo-embed">Enter Vimeo Embed Code:</label>
        <textarea id="vimeo-embed" name="vimeo-embed" rows="4" cols="50" placeholder="Paste the full Vimeo embed code here"></textarea><br><br>
        
        <label for="blog">Write your blog below!</label><br>
        <textarea id="blog" name="blog" rows="4" cols="50"></textarea><br><br>

        <label for="photo">Upload Photo:</label>
        <input type="file" id="photo" name="photo" accept="image/*"><br><br>

        <label for="address">Enter your location:</label>
        <input type="text" id="address" placeholder="Enter a location">
        <button onclick="geocodeAddress()">Get Location</button><br><br>

        <button onclick="createBlogPost()">Create Blog Post</button>
    </section>
    <div id="loading-container">
        <div>Creating your blog post...</div>
        <div id="progress-bar"></div>
    </div>
</body>
</html>
